<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Storage Usage Analyzer - Cumulative</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; padding: 20px; background-color: #f4f4f9; color: #2d3748; }
    button { padding: 10px 18px; cursor: pointer; border-radius: 6px; border: 1px solid #cbd5e0; background: #fff; font-weight: 600; transition: 0.2s; }
    button:hover { background: #edf2f7; }
    
    .summary-card { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: inline-block; border-left: 4px solid #4299e1; }
    
    table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-radius: 8px; table-layout: auto; }
    th, td { padding: 12px 15px; text-align: right; border-bottom: 1px solid #edf2f7; white-space: nowrap; }
    
    /* Give the name column just enough space */
    th:first-child, td:first-child { text-align: left; width: 1%; } 
    
    /* Make the cumulative column wide to accommodate a long progress bar */
    .col-cumulative { text-align: left; width: auto; }

    th { background-color: #f8fafc; color: #4a5568; font-size: 11px; text-transform: uppercase; cursor: pointer; letter-spacing: 0.05em; }

    /* Wide Cumulative Bar */
    .cum-wrapper { display: flex; align-items: center; gap: 15px; width: 100%; }
    .cum-container { flex-grow: 1; background: #edf2f7; height: 14px; border-radius: 7px; overflow: hidden; min-width: 200px; }
    .cum-bar { height: 100%; background: linear-gradient(90deg, #4299e1 0%, #3182ce 100%); transition: width 0.5s ease-out; }
    .cum-text { min-width: 50px; font-weight: bold; font-size: 13px; color: #2b6cb0; }

    /* Modal */
    .modal { display: block; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
    .modal-content { background: #fff; margin: 5% auto; padding: 25px; border-radius: 12px; width: 80%; max-width: 900px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    textarea { width: 100%; height: 350px; font-family: 'Fira Code', monospace; margin: 15px 0; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; box-sizing: border-box; font-size: 12px; }
  </style>
</head>
<body>
  <div id="app">
    <button @click="showModal = true">ðŸ“‚ Load Data</button>

    <div class="summary-card" v-if="quotaData.length">
        <strong>Total Disk footprint:</strong> {{ formatSize(totalSystemUsed) }} 
        <small style="color: #718096; margin-left: 10px;">({{ (totalSystemUsed * 1024).toLocaleString() }} Bytes)</small>
    </div>

    <div class="modal" v-if="showModal">
      <div class="modal-content">
        <h3>Paste repquota Output</h3>
        <textarea v-model="rawInput" placeholder="Paste results here..."></textarea>
        <div style="text-align: right;">
            <button @click="parseQuota" style="background: #3182ce; color: white; border: none; padding: 12px 24px;">Analyze Storage</button>
        </div>
      </div>
    </div>

    <table v-if="quotaData.length">
      <thead>
        <tr>
          <th>User</th>
          <th>Used Bytes</th>
          <th>Human Readable</th>
          <th>% Share</th>
          <th class="col-cumulative">Cumulative % (Downward)</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(row, index) in quotaData" :key="row.user">
          <td><strong>{{ row.user }}</strong></td>
          <td style="font-family: monospace; color: #718096;">{{ (row.blockUsed * 1024).toLocaleString() }}</td>
          <td style="font-weight: 500;">{{ formatSize(row.blockUsed) }}</td>
          <td>{{ ((row.blockUsed / totalSystemUsed) * 100).toFixed(2) }}%</td>
          <td class="col-cumulative">
            <div class="cum-wrapper">
                <div class="cum-container">
                    <div class="cum-bar" :style="{ width: row.cumulativePct + '%' }"></div>
                </div>
                <span class="cum-text">{{ row.cumulativePct.toFixed(1) }}%</span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          showModal: true,
          rawInput: '',
          quotaData: [],
          totalSystemUsed: 0
        };
      },
      methods: {
        formatSize(kb) {
          if (kb === 0) return '0 KB';
          if (kb < 1024) return kb + ' KB';
          if (kb < 1024 * 1024) return (kb / 1024).toFixed(2) + ' MB';
          if (kb < 1024 * 1024 * 1024) return (kb / (1024 * 1024)).toFixed(2) + ' GB';
          return (kb / (1024 * 1024 * 1024)).toFixed(2) + ' TB';
        },
        parseQuota() {
          const lines = this.rawInput.split('\n').filter(line => 
             /^[a-zA-Z0-9]/.test(line.trim()) && !line.startsWith('User') && !line.startsWith('***')
          );

          let items = lines.map(line => {
            const parts = line.trim().split(/\s+/);
            return {
              user: parts[0],
              blockUsed: +parts[2] || 0
            };
          });

          // Sort by usage descending
          items.sort((a, b) => b.blockUsed - a.blockUsed);

          this.totalSystemUsed = items.reduce((sum, item) => sum + item.blockUsed, 0);
          
          let runningTotal = 0;
          this.quotaData = items.map(item => {
            runningTotal += item.blockUsed;
            return {
              ...item,
              cumulativePct: this.totalSystemUsed > 0 ? (runningTotal / this.totalSystemUsed) * 100 : 0
            };
          });

          this.showModal = false;
        }
      }
    }).mount('#app');
  </script>
</body>
</html>